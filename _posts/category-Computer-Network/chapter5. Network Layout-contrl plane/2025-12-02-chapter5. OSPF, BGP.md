---
title: "chapter5-3, 4. Network Layer: intra-ISP routing: OSPF, routing among ISPs: BGP"
excerpt: ""

wirter: sohee Kim
categories:
  - Computer Network
tags:
  - CS

toc: true
use_math: true 
toc_sticky: true

date: 2025-12-02
last_modified_at: 2025-12-02
---

intra-ISP routing: OSPF
====

&ensp;왜 Routing을 Scalability 있게 만들어야 할까?<br/>
&ensp;지금까지 우리가 배운 라우팅 알고리즘(Dijkstra, Bellman-Ford 등)은 "이상적인 환경"을 가정한 것.<br/>
&ensp;하지만 현실 인터넷은 다음 두 가지 문제 때문에 그렇게 단순하지 않음.<br/>

&ensp;(1) Scale 문제 — 너무 많은 목적지<br/>
&ensp;인터넷에는 수십억 개의 목적지(IP 주소, 서버, 장비 등)가 있음<br/>
&ensp;그래서 문제 발생:<br/>
* 모든 목적지를 라우팅 테이블에 저장할 수 없음
* 모든 라우터가 서로에게 전체 라우팅 테이블을 계속 보내면 → 링크가 Overflow

&ensp;flat network(모두가 모두에게 연결) 구조는 절대 불가능함.<br/>

&ensp;(2) Administrative Autonomy — 관리 주체가 다름<br/>
&ensp;인터넷은 단일 기관이 관리하는 네트워크가 아님.<br/>
&ensp;인터넷 = 수천 개의 독립적인 네트워크(기업·ISP·기관) 들의 집합<br/>
&ensp;각 네트워크는 자기 라우팅을 “자율적으로” 결정하고 싶어 함<br/>

&ensp;그래서 등장한 개념: Autonomous System (AS)<br/>

## Autonomous System (AS)

&ensp;인터넷의 라우터들을 AS(자율 시스템) 단위로 묶음.<br/>
&ensp;AS = 동일한 관리 도메인(기업, ISP, 국가기관 등)에 있는 라우터들의 집합, 내부에서는 “하나의 통일된 라우팅 규칙”을 사용<br/>

&ensp;서로 다른 AS 간의 라우팅 구조<br/>
&ensp;(1) Intra-AS routing (intra-domain routing)<br/>
&ensp;AS 내부 라우팅<br/>
&ensp;사용 프로토콜 예<br/>
* OSPF
* RIP

&ensp;특징:<br/>
* AS 안 모든 라우터가 같은 프로토콜 사용해야 함
* 내부적 최단거리 기반 라우팅

&ensp;(2) Inter-AS routing (inter-domain routing)<br/>
&ensp;즉, AS와 AS 사이 라우팅<br/>
&ensp;사용 프로토콜:<br/>
* BGP(Border Gateway Protocol) ← 인터넷 전체를 움직이는 핵심

&ensp;역할:<br/>
* 외부 목적지(다른 AS에 있는 주소)를 어떻게 갈지 결정

&ensp;Inter-AS 와 Intra-AS의 관계<br/>
<p align="center"><img src="/assets/img/Computer Network/chapter5. Network Layer-Control Plane/5-22.png" width="500"></p>

* AS 내부 경로: OSPF 같은 Intra-AS
* AS 간 경로: BGP 같은 Inter-AS

&ensp;라우터의 Forwarding table은 두 가지 정보로 구성됨:<br/>
```css
[ Intra-AS routing 결과 ] + [ Inter-AS routing(BGP) 결과 ]
```

* AS 내부 목적지는 "내부 알고리즘(OSPF 등)" 결정
* 외부 목적지는 "BGP가 알려준 Gateway"를 통해 나감

&ensp;Inter-AS가 Intra-AS에 영향을 주는 이유<br/>
> AS 내부 라우터가 외부 목적지로 패킷을 보낼 때 어느 Gateway를 이용해야 하는가?

&ensp;AS1 내부에서 외부 네트워크로 가는 길이 여러 개 있을 수 있음:<br/>
* AS1 → AS2 경유
* AS1 → AS3 경유<br/>
&ensp;=> 어떤 경로가 더 좋지?<br/>
&ensp;이걸 알려주는 것이 Inter-AS(BGP)<br/>

&ensp;Inter-AS가 해야 하는 두 가지<br/>
&ensp;(1) 어떤 외부 AS들이 reachable 한지 배워야 함<br/>
&ensp;예)<br/>
* 목적지 10.0.0.0/8 → AS2 통해 도달
* 목적지 20.0.0.0/8 → AS3 통해 도달

&ensp;이 정보를 Gateway router가 BGP로 수신함.<br/>

&ensp;(2) 이 정보를 AS 내 모든 라우터에 전파<br/>
&ensp;그래야 AS1 내부의 모든 라우터가 알 수 있음:<br/>
* External Reachability 정보를 BGP가 학습
* 이를 AS 내부 라우터들에게 전달해서 포워딩 테이블을 구성

### Intra-AS Routing(AS 내부 라우팅)

&ensp;RIP / EIGRP / OSPF (AS 내부 라우팅 프로토콜)<br/>
&ensp;RIP (Routing Information Protocol)<br/>
* Distance Vector(DV) 라우팅
* hop count 기반 (최단 hop)
* 30초마다 라우팅 업데이트 브로드캐스트
* count-to-infinity 문제
* 현재는 거의 사용 안 함

&ensp;EIGRP (Enhanced Interior Gateway Routing Protocol)<br/>
* Cisco 사가 만든 DV 기반 개선 프로토콜
* 예전엔 Cisco만 지원했지만 2013에 공개됨

&ensp;OSPF (Open Shortest Path First)<br/>
* 링크 상태(Link-State) 기반
* Dijkstra 알고리즘 사용해 최단 경로 계산
* RIP보다 빠르고 정확하고 안정적
* 기업/기관/ISP 내부 라우팅 대부분이 OSPF

&ensp;OSPF 핵심 특징<br/>
&ensp;Open: RFC 표준 기반, 누구나 사용할 수 있음<br/>

&ensp;링크 상태 방식<br/>
&ensp;각 라우터가 하는 일:<br/>

&ensp;1) LS Advertisement(LSA) 플러딩<br/>
* 연결된 링크 상태 정보를 모든 OSPF 라우터에게 퍼뜨림
* IP에 직접 실려 전달됨 (TCP/UDP 사용 안 함)

&ensp;2) 모든 라우터는 동일한 전체 토폴로지(지도)를 갖게 됨<br/>
* 전체 맵을 가지고 있기 때문에 오차가 적다

&ensp;3) Dijkstra 알고리즘으로 모든 목적지의 최단 경로 계산<br/>
* Link-State가 Distance Vector보다 빠르고 정확한 이유!

&ensp;4) 보안: 모든 OSPF 메시지는 인증됨<br/>
* 악의적 라우터가 "이쪽으로 오세요~"라고 속일 수 없도록 보호

&ensp;**Hierarchical OSPF (계층형 OSPF)**<br/>
<p align="center"><img src="/assets/img/Computer Network/chapter5. Network Layer-Control Plane/5-23.png" width="500"></p>

&ensp;두 계층 구조<br/>
&ensp;1) Backbone Area(Area 0)<br/>
* 네트워크의 중심
* 다른 Area들끼리 연결하는 역할
* 모든 AREA는 반드시 Area 0과 연결되어야 함

&ensp;2) Local Area(Area 1, 2, 3 …)<br/>
* 세부 구역
* 내부에서는 자신의 Area 내부 LSA만 플러딩

&ensp;OSPF에서 등장하는 라우터 종류<br/>

&ensp;Local router (내부 라우터)<br/>
* Area 내부에서만 라우팅
* LSA를 자기 area 안에서만 퍼뜨림

&ensp;Area Border Router (ABR)<br/>
* Area와 Backbone을 연결하는 라우터
* Area 내부의 라우팅 정보를 "요약(summary)"해서 Backbone에 전달 → 규모가 큰 네트워크에서도 효율적

&ensp;Backbone Router<br/>
* Area 0 내에서 라우팅
* Backbone에서 발생하는 LSA만 처리

&ensp;Boundary Router (ASBR)<br/>
* 외부 AS로 연결되는 라우터
* OSPF → BGP와 연결될 때 이 라우터 사용

routing among ISPs: BGP
====

&ensp;**BGP: Internet의 inter-domain routing 프로토콜**<br/>
&ensp;BGP(Border Gateway Protocol): 인터넷을 구성하는 수많은 ISP(AS) 들이 서로 라우팅 정보를 교환하도록 해주는 프로토콜<br/>
* 인터넷을 하나로 붙잡아주는 접착제
* Link-State(OSPF)나 Distance Vector(RIP)와 다르게 BGP는 Path-Vector 프로토콜

## eBGP 와 iBGP

<p align="center"><img src="/assets/img/Computer Network/chapter5. Network Layer-Control Plane/5-24.png" width="500"></p>

&ensp;eBGP(External BGP)<br/>
* AS끼리 외부 경로 정보를 주고받는 프로토콜
* 예: KT(AS 4766) ↔ SKB(AS 9633), Google ↔ LGU+ 등
* 역할: 어떤 목적지가 있으니 우리 AS를 통해 갈 수 있다고 알려줌

&ensp;iBGP(Internal BGP)<br/>
* 하나의 AS 내부에서 BGP 경로 정보를 모든 라우터에게 전파
* 목적: AS 전체에 외부 도달성(reachability)을 퍼뜨리기 위함

### BGP 세션 (BGP session)

<p align="center"><img src="/assets/img/Computer Network/chapter5. Network Layer-Control Plane/5-25.png" width="500"></p>

* BGP 라우터(피어, peer)끼리 TCP 연결 위에서 메시지를 주고받음
* 안정적이고, 끊어지지 않는 세션 유지

&ensp;왜 TCP 위에서 돌까?<br/>
* 신뢰 보장 필요 (경로 정보가 유실되면 안 됨)
* 지속적 연결 유지 필요

&ensp;BGP에서 광고(advertisement)의 의미<br/>
* "우리 AS3이 목적지 X로 가는 길이 있어! 너희가 패킷 보내면 내가 X로 전달해줄게."
* 즉 **경로 제공을 약속(promises)**하는 것

&ensp;Path Attributes (경로 속성)<br/>
&ensp;BGP가 광고하는 정보는 단순한 목적지 뿐만 아니라 다음과 같은 경로 속성(attribute)을 포함한다.<br/>
&ensp;1) AS-PATH<br/>
* 패킷이 지나온 AS들의 목록
* 예: AS3 → AS2 → AS1 이면 AS-PATH = {3, 2, 1}
* 용도: 루프 방지, 짧은 경로 선호 위한 기준

&ensp;2) NEXT-HOP<br/>
* 목적지로 가기 위해 다음으로 갈 라우터의 IP
* AS 내부 라우터들이 외부로 나갈 때 누구에게 전달할지 결정할 때 사용

&ensp;Policy-Based Routing<br/>
&ensp;OSPF처럼 단순히 cost 기반이 아님<br/>
&ensp;AS마다 ‘정책(policy)’이 다르다. 그래서 BGP는 최단 경로 라우팅이 아니다.<br/>

### BGP path advertisement

<p align="center"><img src="/assets/img/Computer Network/chapter5. Network Layer-Control Plane/5-26.png" width="500"></p>

&ensp;1단계: AS3(3a) → AS2(2c)<br/>
&ensp;AS3 라우터 3a가 ‘X라는 목적지까지 갈 수 있다’는 정보를 외부 AS(AS2)에게 알림<br/>
* 광고 내용: AS-PATH = AS3, X
* 전달 방식: eBGP (서로 다른 AS끼리)

&ensp;2단계: AS2 내부에서 2c → (2a, 2b, 2d)<br/>
&ensp;AS2 router 2c는 받은 경로를 **정책(policy)**에 따라 수락(accept)할지 먼저 결정함.<br/>
* 수락하면 AS2 내부 라우터들에게 전달함
* 방식: iBGP (AS 내부 공유)

&ensp;3단계: AS2(2a) → AS1(1c)<br/>
&ensp;AS2 router 2a는 이 정보를 다시 AS1에게 eBGP로 전달<br/>
&ensp;단, AS-PATH 앞에 AS2를 추가함<br/>
* 변환된 경로: AS2, AS3, X

1. 경로 광고는 AS 밖으로 → 내부로 → 다시 밖으로 퍼져 나간다.
2. AS를 벗어날 때는 eBGP, 내부는 iBGP
3. AS-PATH는 앞에 자신을 붙이며 길어짐

&ensp;AS1의 gateway router 1c는 두 가지 경로를 알게 됨<br/>
1. AS2 → AS3 → X 경로
* 2a가 전달
* AS-PATH: AS2, AS3, X
2. AS3 → X 직접 경로
* 3a가 직접 전달
* AS-PATH: AS3, X

&ensp;두 경로 모두 AS1 입장에서는 X로 갈 수 있는 "대안 경로"다.<br/>

&ensp;선택은 정책(policy) 기반<br/>
&ensp;라우팅 기준은 단순 shortest path가 아님.<br/>
&ensp;따라서 1c는: AS-PATH = AS3, X 를 선택했다고 가정 → "더 짧고 더 선호되는 경로(정책상)"라고 판단했기 때문<br/>
&ensp;선택한 경로를 AS1 내부로 iBGP로 전파<br/>

1. BGP는 하나의 목적지에 대해 여러 경로를 학습한다.
2. 최종 선택은 정책 기반(policy-based routing)
3. 선택된 경로만 AS 내부로 퍼진다.

&ensp;예시<br/>
<p align="center"><img src="/assets/img/Computer Network/chapter5. Network Layer-Control Plane/5-27.png" width="500"></p>

&ensp;상황 설명<br/>
* 목적지 X는 AS3에 있음.
* AS3의 게이트웨이 3a가 AS2의 게이트웨이 2c에게 경로: AS3, X 를 eBGP로 알려줌.
* 그 후 AS2 내부에서는 iBGP로 2c → 2a, 2b, 2d 로 경로가 퍼짐.

&ensp;이제 AS1의 게이트웨이 1c는<br/>
* 2a로부터 AS2, AS3, X 경로를 받고
* 3a로부터 AS3, X 경로도 받음.

&ensp;1c는 AS1 내부에 iBGP로 info 전달해서 **AS1의 모든 라우터(1a, 1b, 1d)가 “X로 가려면 1c로 가라”**는 것을 알게 됨.<br/>

&ensp;중요한 핵심: OSPF + BGP 결합<br/>
* AS 내부 라우팅은 OSPF (intra-domain routing)
* AS 간 라우팅은 BGP (inter-domain routing)

&ensp;X까지 가는 BGP 경로는 알되, 실제 1c까지 가는 길은 OSPF가 계산함<br/>

&ensp;예시: 라우터 1d의 Forwarding table<br/>

| dest | interface |
| ---- | --------- |
| 1c   | 1         |
| X    | 1         |

* "X로 가는 패킷? → 1c로 보내! (OSPF가 계산한 최단 인터페이스 = 1)"
* 실제 X까지는 BGP 경로 사용
* 1c까지는 OSPF 사용

&ensp;X까지 가는 경로는 BGP가 알려줬고 1c까지 가는 경로는 OSPF가 알려줬다.<br/>

&ensp;1c가 배우는 두 가지 경로<br/>
1. 2a → 1c : AS2, AS3, X
2. 3a → 1c : AS3, X

&ensp;1c는 "정책(policy)"을 기반으로 경로 선택한다.<br/>
&ensp;OSPF처럼 단순 shortest path가 아니라 관리자가 정해놓은 정책을 따른다.<br/>
&ensp;선택된 경로를 AS1 내부에 iBGP로 퍼뜨린다.<br/>

&ensp;**BGP messages**<br/>
&ensp;BGP는 TCP 위에서 동작<br/>
* 포트 179
* 신뢰성, 안정성 확보
* Routing protocol 중 거의 유일하게 TCP 사용

&ensp;BGP 메시지 종류<br/>
&ensp;1) OPEN<br/>
* BGP 세션을 연다
* 나 BGP 피어 열고 싶다, 인증할게!

&ensp;2) UPDATE<br/>
* 가장 중요
* 새로운 경로 광고
* 기존 경로 철회(withdrawal) 전달

&ensp;즉, 인터넷 전체의 라우팅 정보가 이 메시지로 움직임.<br/>

&ensp;3) KEEPALIVE<br/>
* 아무 소식 없으면 연결이 죽은 줄 알기 때문에
* UPDATE가 없어도 주기적으로 보냄
* OPEN에 대한 ACK 역할도 함

&ensp;4) NOTIFICATION<br/>
* 오류 보고
* 심각한 에러 발생 시 연결 종료

### Hot potato routing

&ensp;AS 내부에서 X로 가기 위해 어떤 외부 게이트웨이를 선택할까?<br/>

&ensp;상황<br/>
&ensp;2d 라우터는 BGP로 X까지 갈 수 있는 두 경로가 있다는 걸 알고 있다.<br/>
* 2d → 2a → 1c → AS3 → X
* 2d → 2c → 1c → AS3 → X

&ensp;경로 AS 홉 수는 신경 안 씀.<br/>

&ensp;Hot potato routing 규칙<br/>
&ensp;자기 AS 안에서 비용이 가장 작은 게이트웨이를 선택<br/>
&ensp;2d는 자신에서 2a까지 가는 intra-OSPF 비용이 더 작으므로 2a로 보냄<br/>

&ensp;요약<br/>
&ensp;AS 내부: OSPF<br/>
* 최단 거리 성능 중심
* 링크 비용으로 계산

&ensp;AS 외부: BGP<br/>
* 정책 기반
* 경로(AS Path) 기반
* 경제적 관계/정책이 더 우선

&ensp;Hot potato routing<br/>
* 외부로 제일 빨리 패킷을 내보내는 게 목표(AS 내부 비용 최소)

### BGP: achieving policy via advertisements

&ensp;ISPs는 자기 고객 트래픽만 처리하고 싶다.<br/>
<p align="center"><img src="/assets/img/Computer Network/chapter5. Network Layer-Control Plane/5-28.png" width="500"></p>

* A, B, C = ISP(provider network)
* w, x, y = customer network

&ensp;상황:<br/>
* 고객 w → A → B or C → x, y 로 갈 수 있다.
* A는 자신이 w라는 고객을 가지고 있으므로 "A, w로 갈 수 있다." 는 경로를 B와 C에게 광고한다.

&ensp;핵심 정책: "B는 Cdprp BA, w 경로를 광고하지 않는다."<br/>

&ensp;이유 1) B는 돈을 못 벌기 때문<br/>
* C → B → A → w 이런 경로는 C도 B의 고객 아님, A도 고객 아님, w도 고객 아님 → 즉 B는 아무 이득 없이 남의 트래픽을 처리해줘야 함 (transit!)

&ensp;이유 2) 정책 위반 방지<br/>
* ISP는 자기 고객의 트래픽만 처리하고 싶어함
* 다른 ISP끼리의 트래픽은 절대 중계해주지 않음

&ensp;결과<br/>
* C는 B를 통한 경로 BA, w를 절대 알지 못함
* C 입장에서는 w로 가려면 C → A → w 만 보임

&ensp;이번엔 다른 형태의 정책: 고객 x의 정책<br/>
&ensp;상황<br/>
* x는 B와 C 두 ISP에 연결된 고객 (dual-homed)
* x는 다음 정책을 원한다: 나는 B → C → x 로 오는 트래픽을 원하지 않는다.

&ensp;B가 자신의 고객처럼 트래픽을 들고 오지 않았으면 한다.<br/>
&ensp;구현 방법<br/>
* x는 C에게 "x로 가는 경로"를 광고하지만 x는 B에게 C로 가는 경로를 광고하지 않음 → B는 C→x 경로를 모르게 됨.

&ensp;정책이 광고 억제로 구현됨<br/>

&ensp;BGP route selection<br/>
&ensp;정책 적용 후, 라우터는 여러 경로 중 최종 하나를 선택해야 한다.<br/>

&ensp;1. Local Preference(정책 기반)
&ensp;가장 먼저 고려하는 값<br/>
* 값이 높을수록 선호
* ISP가 직접 설정하는 정책 기반

&ensp;2. Shortest AS-PATH<br/>
&ensp;AS path가 짧을수록 좋음<br/>

&ensp;3. Hot Potato Routing (NEXT-HOP distance)<br/>
* AS 내부(Ospf)에서 가장 가까운 Next-Hop 게이트웨이 선택
* 외부 AS 비용은 고려하지 않음

&ensp;4. Additional criteria (기타)<br/>
* MED, router ID 등

