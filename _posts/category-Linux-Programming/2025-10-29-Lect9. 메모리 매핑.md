---
title: "Lect9. 메모리 매핑"
excerpt: ""

wirter: sohee Kim
categories:
  - Linux Programming
tags:
  - Linux

toc: true
toc_sticky: true

date: 2025-10-29
last_modified_at: 2025-10-29
---

메모리 매핑(Memory Mapping) 기본 개념
=====

&ensp;메모리 매핑(memeory mapping)이란 파일이나 장치의 내용을 프로세스의 가상 메모리 공간에 직접 연결하는 기법을 말한다.<br/>

&ensp;즉 디스크에 있는 파일 데이터를 read(), write() 시스템 콜 없이 바로 메모리 주소를 통해 접근할 수 있게 만드는 것이다.<br/>

&ensp;**동작 원리** <br/>
&ensp;운영체제는 프로세스마다 가상 메모리 공간을 갖고 있다. `mmap()` 함수를 사용하면 파일의 특정 부분을 이 가상 메모리에 매핑시켜 해당 영역을 읽거나 쓰면 자동으로 파일의 내용이 변경된다.<br/>

&ensp;**파일 <-> 메모리 간의 연결고리를 만들어주는 함수가 mmap()입니다.**<br/>

&ensp;**장점**<br/>

| 구분        | 설명                                       |
| --------- | ---------------------------------------- |
| 성능 향상     | read(), write() 시스템 콜 없이 파일을 메모리에서 직접 접근 |
| 간결한 코드    | 파일 I/O를 포인터 연산처럼 간단히 다룰 수 있음             |
| 프로세스 간 공유 | 동일한 파일을 여러 프로세스가 같은 물리 메모리로 공유 가능        |

관련 시스템 콜
=====

# mmap()

```c
#include <sys/mman.h>

void *mmap(void *addr, size_t len, int prot, int flags, int fd, off_t offset);
```

&ensp;mmap() 함수 인자 설명<br/>
&ensp;`mmap()`은 다음과 같이 동작한다.<br/>
&ensp;fd가 가리키는 파일의 offset부터 len만큼의 데이터를 addr이 가리키는 메모리 공간에 매핑한다.<br/>

&ensp;주요 인자 정리<br/>

| 인자         | 설명                                |
| ---------- | --------------------------------- |
| **addr**   | 매핑할 메모리 주소 (NULL로 지정 시 커널이 자동 배정) |
| **len**    | 매핑할 메모리 크기 (byte 단위)              |
| **prot**   | 보호 모드 (읽기, 쓰기 권한 설정)              |
| **flags**  | 매핑된 데이터의 공유 방법 지정                 |
| **fd**     | 파일 디스크립터 (open으로 얻음)              |
| **offset** | 파일 내 매핑 시작 위치 (페이지 크기 단위)         |

&ensp;prot, flag 인자 & 주의사항<br/>
&ensp;prot 인자<br/>

| 상수           | 의미    |
| ------------ | ----- |
| `PROT_READ`  | 읽기 허용 |
| `PROT_WRITE` | 쓰기 허용 |

&ensp;flag 인자<br/>

| 상수            | 의미                                 |
| ------------- | ---------------------------------- |
| `MAP_SHARED`  | 다른 프로세스와 변경 내용 공유                  |
| `MAP_PRIVATE` | 변경 내용 비공유 (복사 후 쓰기, copy-on-write) |

* 메모리 매핑은 페이지 단위(보통 4KB)로 이루어진다.
    - 페이지 크기 = 4KB = 4096바이트
    - offset은 반드시 4096의 배수여야 한다.
* 매핑된 영역을 벗어나 접근하면 → SIGBUS 또는 SIGSEGV 시그널이 발생한다 (Segmentation fault)

# munmap() - memory mapping 해제

&ensp;`mmap()` 으로 매핑한 메모리 영역을 해제할 때 사용하는 함수이다. 즉 파일과 메모리의 연결을 끊는 역할을 한다.<br/>

```c
#include <sys/mman.h>

int munmap(void *addr, size_t len);
```

| 인자     | 설명                                   |
| ------ | ------------------------------------ |
| `addr` | `mmap()`이 반환한 시작 주소                  |
| `len`  | 매핑된 메모리의 크기 (mmap에서 지정한 len과 동일해야 함) |

&ensp;동작원리<br/>
* 매핑을 해제하면 해당 영역의 접근 권한이 사라진다.
* 해제된 영역을 접근하면 SIGSEGV (Segmentation fault) 발생
* 일반적으로 `munmap()`은 파일 닫기(`close(fd)`) 전에 호출한다.

&ensp;예시<br/>
```c
munmap(addr, length);
close(fd);
```

# mprotect() - 보호 모드 변경

&ensp;이미 매핑된 메모리 영역의 읽기/쓰기 권한(protection mode)을 동적으로 변경할 수 있게 해준다.<br/>

```c
#include <sys/mman.h>

int mprotect(void *addr, size_t len, int prot);
```

| 인자     | 설명                                               |
| ------ | ------------------------------------------------ |
| `addr` | 권한을 변경할 메모리 시작 주소                                |
| `len`  | 변경할 메모리 크기                                       |
| `prot` | 새로운 보호 모드 (ex: PROT_READ, PROT_WRITE, PROT_NONE) |

&ensp;예시<br/>
```c
mprotect(addr, 4096, PROT_READ);      // 읽기만 가능하게 변경
mprotect(addr, 4096, PROT_WRITE);     // 쓰기 권한 추가
```

* `mprotect()` 도 페이지 단위(4KB)로 적용됨
* 쓰기 금지된 영역에 접근하면 SIGSEGV 발생

# truncate(), ftruncate() - 파일 크기 변경

&ensp;파일의 크기를 변경하는 함수이다. 파일이 매핑된 상태에서 크기를 조절할 때 사용한다.<br/>

```c
#include <unistd.h>

// 파일 경로로 변경
int truncate(const char *path, off_t len);

// 파일 디스크립터로 변경
int ftruncate(int fd, off_t len);
```

| 인자            | 설명                |
| ------------- | ----------------- |
| `path` / `fd` | 변경할 파일            |
| `len`         | 새 파일 크기 (byte 단위) |

&ensp;동작 원리<br/>
* 지정한 크기보다 작으면 → 파일을 잘라냄(데이터 손실)
* 지정한 크기보다 크면 → 0으로 채워서 확장됨

&ensp;예시<br/>
```c
ftruncate(fd, 8192);   // 파일을 8KB 크기로 조정
```

&ensp;주의<br/>
* `mmap()` 된 메모리의 크기보다 파일의 더 작게 자르면 이후 접근 시 SIGBUS 오류 발생 (잘린 영역 접근 때문)

# msync() - 매핑된 메모리 동기화

&ensp;`mmap()`으로 매핑된 메모리에 변경사항이 있을 때 그 내용을 파일에 동기화(write-back)하는 함수이다.<br/>

&ensp;사용 방법<br/>
```c
#include <sys/mman.h>

int msync(void *addr, size_t len, int flags);
```

| 인자      | 설명          |
| ------- | ----------- |
| `addr`  | 동기화할 메모리 주소 |
| `len`   | 동기화할 길이     |
| `flags` | 동기화 방식 지정   |

&ensp;flags 인자<br/>

| 인자      | 설명          |
| ------- | ----------- |
| `addr`  | 동기화할 메모리 주소 |
| `len`   | 동기화할 길이     |
| `flags` | 동기화 방식 지정   |

&ensp;예시<br/>
```c
msync(addr, length, MS_SYNC);  // 즉시 파일과 동기화
```

&ensp;활용 예<br/>
* 여러 프로세스가 같은 파일을 공유 매핑할 때 하나의 프로세스가 수정한 내용이 파일에 바로 반영되도록 할 수 있음